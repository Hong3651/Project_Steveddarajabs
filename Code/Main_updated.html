<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìŠ¤í‹°ë¸Œ ë”°ë¼ì¡ìŠ¤: ìµœê³ ì˜ ë°œí‘œë¥¼ ìœ„í•œ AI ì»¨ì„¤í„´íŠ¸</title>
    <style>
        /* í°íŠ¸ ë° ê¸°ë³¸ ì„¤ì •: Apple ìŠ¤íƒ€ì¼ */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f7;
            color: #1d1d1f;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        /* ë©”ì¸ ì»¨í…Œì´ë„ˆ */
        .container {
            width: 100%;
            max-width: 700px;
            padding: 80px 20px;
            text-align: center;
        }

        .header-image {
            width: 400px; 
            height: auto;
            margin-bottom: 0px; 
            display: block; 
            margin-left: auto;
            margin-right: auto; 
            opacity: 0.85; 
        }

        /* ----- ì¹´í”¼ë¼ì´íŠ¸ ìŠ¤íƒ€ì¼ ----- */
        p.headline {
            font-size: 32px;
            font-weight: 600;
            margin-bottom: 40px;
            line-height: 1.4;
            letter-spacing: -0.8px;
        }
        
        /* íŒŒì¼ ì…ë ¥ í•„ë“œ ìˆ¨ê¸°ê¸° */
        input[type="file"] {
            display: none;
        }

        /* ----- íŒŒì¼ ì„ íƒ ë²„íŠ¼ (ìœ¤ê³½ì„  ìŠ¤íƒ€ì¼) ----- */
        .custom-file-upload {
            border: 1px solid #007aff; 
            background-color: transparent; 
            color: #007aff; 
            padding: 12px 30px;
            border-radius: 980px; 
            cursor: pointer;
            font-size: 18px;
            font-weight: 500;
            transition: all 0.2s ease-in-out; 
            display: inline-block;
            box-shadow: none; 
            letter-spacing: -0.5px; 
            margin-bottom: 20px;
        }

        .custom-file-upload:hover {
            background-color: #007aff; 
            color: white; 
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); 
        }

        /* ----- ë©”ì¸ ì•¡ì…˜ ë²„íŠ¼ (ì§„í•œ ë°°ê²½ ìŠ¤íƒ€ì¼) ----- */
        #analyzeButton {
            background-color: #007aff; 
            color: white; 
            border: none; 
            padding: 14px 40px;
            border-radius: 980px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 600;
            letter-spacing: -0.5px;
            transition: opacity 0.2s;
            margin-top: 30px;
            display: block; 
            margin-left: auto;
            margin-right: auto;
            display: none;
        }

        #analyzeButton:disabled {
            opacity: 0.5; 
            cursor: not-allowed;
        }

        #analyzeButton:hover:enabled {
            opacity: 0.85; 
        }

        /* ----- ë™ì˜ìƒ ë¯¸ë¦¬ë³´ê¸° ìŠ¤íƒ€ì¼ ----- */
        #videoPreviewContainer {
            margin-top: 30px;
            border-radius: 10px; 
            overflow: hidden;
            max-width: 100%;
            display: none; 
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        #videoPreview {
            width: 100%;
            height: 200px; 
            display: block;
            background-color: #eaeaec; 
        }
        
        /* íŒŒì¼ ìƒíƒœ ë° ë¡œë”© í‘œì‹œ */
        #fileStatus, #loadingStatus {
            margin-top: 20px;
            font-size: 16px;
            color: #6e6e73;
        }
        
        #fileStatus.ready {
            color: #007aff; 
            font-weight: 600;
        }
        
        /* ----- ë¡œë”© ë°” ìŠ¤íƒ€ì¼ ----- */
        #loadingBarContainer {
            width: 80%;
            height: 6px;
            background-color: #eaeaec; 
            border-radius: 3px;
            overflow: hidden;
            margin: 20px auto 10px;
            display: none; 
        }

        #loadingBar {
            height: 100%;
            width: 0%;
            background-color: #007aff; 
            transition: width 0.3s linear;
        }

        /* íŒŒì¼ í¬ê¸° í‘œì‹œ */
        .file-size {
            font-size: 14px;
            color: #888;
            margin-top: 5px;
        }

    </style>
</head>
<body>
    <div class="container">

        <!-- â˜… ë¡œê³  ì´ë¯¸ì§€ ê²½ë¡œ ìˆ˜ì • í•„ìš” -->
        <img src="static/logo.gif" alt="ìŠ¤í‹°ë¸Œ ë”°ë¼ì¡ìŠ¤" class="header-image" onerror="this.style.display='none'">

        <p class="headline">ë¹„ë¡œì†Œ ë§ˆì£¼í•  ë‹¹ì‹ ì˜ ë°œí‘œ, ë¶ˆëŸ¬ì˜¤ê¸°.</p>
        
        <div class="input-area">
            <label for="videoFile" class="custom-file-upload">
                ë°œí‘œ ì˜ìƒ ì„ íƒ (.mp4)
            </label>
            <input 
                type="file" 
                id="videoFile" 
                accept="video/*" 
                onchange="handleVideoUpload(event)"
            >
            
            <div id="fileStatus">ì €ëŸ°, ì•„ì§ ë¶„ì„í•  ì˜ìƒì´ ì—†ë„¤ìš”.</div>
            <div class="file-size" id="fileSize"></div>
            
            <div id="videoPreviewContainer">
                <video id="videoPreview" controls muted></video>
            </div>
            
            <button id="analyzeButton" onclick="startAnalysis()">
                ë¶„ì„ ì‹œì‘
            </button>
            
            <div id="loadingStatus" style="display: none;"></div>
            <div id="loadingBarContainer">
                <div id="loadingBar"></div>
            </div>
            
        </div>
    </div>

    <script>
        const fileStatusElement = document.getElementById('fileStatus');
        const fileSizeElement = document.getElementById('fileSize');
        const videoPreviewContainer = document.getElementById('videoPreviewContainer');
        const videoPreview = document.getElementById('videoPreview');
        const analyzeButton = document.getElementById('analyzeButton');
        const loadingStatus = document.getElementById('loadingStatus');
        const loadingBarContainer = document.getElementById('loadingBarContainer');
        const loadingBar = document.getElementById('loadingBar');
        let currentVideoFile = null;

        // íŒŒì¼ í¬ê¸°ë¥¼ ì½ê¸° ì‰¬ìš´ í˜•ì‹ìœ¼ë¡œ ë³€í™˜
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // ì˜ìƒ íŒŒì¼ ì„ íƒì„ ì²˜ë¦¬í•˜ê³  ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” JavaScript í•¨ìˆ˜
        function handleVideoUpload(event) {
            const file = event.target.files[0];
            currentVideoFile = file;

            // ë¡œë”© UI ì´ˆê¸°í™”
            loadingStatus.style.display = 'none';
            loadingBarContainer.style.display = 'none';
            loadingBar.style.width = '0%';
            loadingBar.style.backgroundColor = '#007aff';

            if (file) {
                // íŒŒì¼ì´ ì„ íƒëœ ê²½ìš°
                fileStatusElement.textContent = `ì—…ë¡œë“œ ì¤€ë¹„ ì™„ë£Œ: ${file.name}`;
                fileStatusElement.classList.add('ready');
                fileSizeElement.textContent = `íŒŒì¼ í¬ê¸°: ${formatFileSize(file.size)}`;
                analyzeButton.style.display = 'block';

                // ì¸ë„¤ì¼/ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
                const videoURL = URL.createObjectURL(file);
                videoPreview.src = videoURL;
                videoPreviewContainer.style.display = 'block';

            } else {
                // íŒŒì¼ ì„ íƒì´ ì·¨ì†Œëœ ê²½ìš°
                fileStatusElement.textContent = 'ë§ˆìŒì´ ë°”ë€Œì…¨ë‚˜ ë³´êµ°ìš”. ì¤€ë¹„ë˜ì‹œë©´ ë‹¤ì‹œ ë¶ˆëŸ¬ì£¼ì„¸ìš”.';
                fileStatusElement.classList.remove('ready');
                fileSizeElement.textContent = '';
                analyzeButton.style.display = 'none';

                // ë¯¸ë¦¬ë³´ê¸° ìˆ¨ê¹€
                videoPreviewContainer.style.display = 'none';
                videoPreview.src = '';
                currentVideoFile = null;
            }
        }

        // â˜…â˜…â˜… ë¶„ì„ ì‹œì‘ í•¨ìˆ˜ (ì‹¤ì œ íŒŒì¼ ì—…ë¡œë“œ) â˜…â˜…â˜…
        async function startAnalysis() {
            if (!currentVideoFile) return;

            // UI ì „í™˜ (ë¶„ì„ ì‹œì‘)
            analyzeButton.style.display = 'none'; 
            fileStatusElement.style.display = 'none';
            fileSizeElement.style.display = 'none';
            loadingStatus.style.display = 'block';
            loadingBarContainer.style.display = 'block';
            videoPreviewContainer.style.display = 'none'; 
            
            // â˜… ì‹¤ì œ íŒŒì¼ì„ FormDataë¡œ ì „ì†¡
            const formData = new FormData();
            formData.append('video', currentVideoFile);

            // Flask ì„œë²„ ì£¼ì†Œ (ì„œë²„ ì‹¤í–‰ ì‹œ í¬íŠ¸ 5000)
            const API_ENDPOINT = 'http://127.0.0.1:5000/analyze_presentation'; 
            const RESULT_PAGE_URL = 'analysis_result.html'; 
            
            // ë¡œë”© ë°” ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘
            let progressValue = 0;
            const loadingInterval = setInterval(() => {
                if (progressValue < 90) {
                    progressValue += 0.5;
                    loadingBar.style.width = progressValue + '%';
                    loadingStatus.textContent = `ğŸ”¬ AIê°€ ë°œí‘œë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤... ${Math.floor(progressValue)}%`;
                }
            }, 200);

            try {
                console.log('[Client] ì˜ìƒ ì—…ë¡œë“œ ì‹œì‘...');
                
                // â˜… ì„œë²„ì— íŒŒì¼ ì—…ë¡œë“œ POST ìš”ì²­
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    body: formData  // FormDataë¡œ íŒŒì¼ ì „ì†¡
                });

                clearInterval(loadingInterval);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('[Client] ì„œë²„ ì‘ë‹µ:', result);

                    if (result.success) {
                        // ì„±ê³µ
                        loadingBar.style.width = '100%';
                        loadingStatus.textContent = 'ğŸ‰ ë¶„ì„ ì™„ë£Œ! ë¦¬í¬íŠ¸ ìƒì„± ì¤‘...';
                        
                        // â˜… ì„œë²„ì—ì„œ ë°›ì€ ì˜ìƒ ê²½ë¡œ ì €ì¥
                        const videoPath = result.video_path || currentVideoFile.name;
                        localStorage.setItem('mainVideoPath', videoPath);
                        localStorage.setItem('videoId', result.video_id || 'unknown');
                        
                        // í”¼ë“œë°± ê²°ê³¼ ì €ì¥
                        localStorage.setItem('analysisFeedback', result.analysis_result);
                        
                        // ìŠ¤í‹°ë¸Œ ì¡ìŠ¤ ì°¸ê³  ì˜ìƒ ê²½ë¡œ (ê³ ì •)
                        localStorage.setItem('steveVideoPath', '/home/piai/ai_project/ì˜ìƒraw/steves.mp4'); 

                        // ê²°ê³¼ í˜ì´ì§€ë¡œ ì´ë™
                        setTimeout(() => {
                            window.location.href = RESULT_PAGE_URL; 
                        }, 1000);

                    } else {
                        throw new Error(result.message || 'ë¶„ì„ ì‹¤íŒ¨');
                    }

                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜');
                }

            } catch (error) {
                clearInterval(loadingInterval);
                loadingStatus.textContent = `ğŸš¨ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`;
                loadingBar.style.width = '0%';
                loadingBar.style.backgroundColor = 'red';
                console.error('API Call Failed:', error);
                
                // ì¬ì‹œë„ ë²„íŠ¼ í‘œì‹œ
                setTimeout(() => {
                    fileStatusElement.style.display = 'block';
                    fileStatusElement.textContent = 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                    fileStatusElement.classList.remove('ready');
                    analyzeButton.style.display = 'block';
                    analyzeButton.textContent = 'ë‹¤ì‹œ ì‹œë„';
                }, 2000);
            }
        }
    </script>
</body>
</html>
